# .github/workflows/code_review.yml
name: "Revis√£o de C√≥digo com Agente Genesys"

on:
  push:
    branches:
      - main

jobs:
  code-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 2 # Precisamos do commit anterior para comparar

      - name: Obter informa√ß√µes do √∫ltimo commit
        id: commit_info
        run: |
          echo "COMMIT_MESSAGE=$(git log -1 --pretty=%B)" >> $GITHUB_ENV
          echo "COMMIT_DIFF=$(git diff HEAD~1 HEAD)" >> $GITHUB_ENV

      - name: Enviar para revis√£o do Agente Genesys
        id: genesis_review
        run: |
          PROMPT="Fa√ßa uma revis√£o de c√≥digo para o seguinte commit. Mensagem: '${{ env.COMMIT_MESSAGE }}'. Diff das mudan√ßas: \n\n${{ env.COMMIT_DIFF }}"
          
          JSON_PAYLOAD=$(jq -n --arg prompt "$PROMPT" '{"prompt": $prompt}')

          RESPONSE=$(curl -s -X POST "${{ secrets.GENESYS_API_URL }}" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.GENESYS_API_TOKEN }}" \
            -d "$JSON_PAYLOAD")
            
          # Extrai a resposta e a prepara para o pr√≥ximo passo
          REVIEW_COMMENT=$(echo "$RESPONSE" | jq -r .response)
          echo "REVIEW_COMMENT<<EOF" >> $GITHUB_ENV
          echo "$REVIEW_COMMENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Comentar no Commit
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `### ü§ñ Revis√£o do Agente Genesys:\n\n${process.env.REVIEW_COMMENT}`
            })
